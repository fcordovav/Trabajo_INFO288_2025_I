2025-05-10T12:44:13.101819,2025-05-10T12:44:13.104934,1,libro,a la tesis,3.11,2
2025-05-10T12:44:44.120655,2025-05-10T12:44:44.122722,1,libro,{'libro'},2.0,3
2025-05-10T14:42:45.951036,2025-05-10T14:42:45.963798,4,articulo,{'articulo'},12.77,3
2025-05-10T14:42:45.920777,2025-05-10T14:42:45.933378,2,tesis,{'tesis'},12.61,3
2025-05-10T14:42:45.850804,2025-05-10T14:42:45.869809,1,libro,{'libro'},19.01,3
2025-05-10T14:43:50.095138,2025-05-10T14:43:50.099532,1,libro,{'libro'},4.35,3
2025-05-10T14:43:50.108120,2025-05-10T14:43:50.109279,2,tesis,{'tesis'},1.11,3
2025-05-10T14:43:50.119246,2025-05-10T14:43:50.229919,3,video,{'video'},110.57,3
2025-05-10T14:43:50.252906,2025-05-10T14:43:50.255359,4,articulo,{'articulo'},2.38,3
2025-05-10T14:44:14.089424,2025-05-10T14:44:14.090577,4,articulo,ecuaciones diferenciales,1.16,0
2025-05-10T14:44:14.063378,2025-05-10T14:44:14.064665,1,libro,ecuaciones diferenciales,1.29,2
2025-05-10T14:44:14.072950,2025-05-10T14:44:14.074069,2,tesis,ecuaciones diferenciales,1.12,0
2025-05-10T14:44:14.080391,2025-05-10T14:44:14.081285,3,video,ecuaciones diferenciales,0.89,0
2025-05-10T15:01:47.373655,2025-05-10T15:01:47.375744,2,tesis,ecuaciones diferenciales,2.08,0
2025-05-10T15:01:47.400175,2025-05-10T15:01:47.401358,4,articulo,ecuaciones diferenciales,1.18,0
2025-05-10T15:01:47.388060,2025-05-10T15:01:47.390333,3,video,ecuaciones diferenciales,2.27,0
2025-05-10T15:01:47.269629,2025-05-10T15:01:47.271230,1,libro,ecuaciones diferenciales,1.6,2
2025-05-10T15:02:12.890270,2025-05-10T15:02:12.891357,4,articulo,sistemas distruibuidos blockchain,1.1,1
2025-05-10T15:02:12.865206,2025-05-10T15:02:12.866338,1,libro,sistemas distruibuidos blockchain,1.13,0
2025-05-10T15:02:12.875233,2025-05-10T15:02:12.876810,2,tesis,sistemas distruibuidos blockchain,1.43,0
2025-05-10T15:02:12.883655,2025-05-10T15:02:12.884371,3,video,sistemas distruibuidos blockchain,0.71,0
2025-05-10T15:02:20.280303,2025-05-10T15:02:20.281041,2,tesis,sistemas distruibuidos blockchain sobre de,0.74,2
2025-05-10T15:02:20.293691,2025-05-10T15:02:20.295009,4,articulo,sistemas distruibuidos blockchain sobre de,1.32,3
2025-05-10T15:02:20.272973,2025-05-10T15:02:20.274058,1,libro,sistemas distruibuidos blockchain sobre de,1.09,0
2025-05-10T15:02:20.286339,2025-05-10T15:02:20.287135,3,video,sistemas distruibuidos blockchain sobre de,0.8,2
2025-05-10T15:07:54.053662,2025-05-10T15:07:54.055164,2,tesis,{'tesis'},1.5,3
2025-05-10T15:10:37.053682,2025-05-10T15:10:37.054420,4,articulo,{'articulo'},0.73,3
2025-05-10T15:10:37.035820,2025-05-10T15:10:37.036734,1,libro,{'libro'},0.91,3
2025-05-10T15:10:37.045350,2025-05-10T15:10:37.046407,2,tesis,{'tesis'},1.05,3
2025-05-10T15:10:44.121537,2025-05-10T15:10:44.122644,3,video,a la tesis,1.11,3
2025-05-10T15:10:44.130089,2025-05-10T15:10:44.130997,4,articulo,a la tesis,0.91,1
2025-05-10T15:10:44.106615,2025-05-10T15:10:44.107708,1,libro,a la tesis,1.09,2
2025-05-10T15:10:44.114618,2025-05-10T15:10:44.115647,2,tesis,a la tesis,1.03,1
2025-05-10T15:11:14.662485,2025-05-10T15:11:14.663466,4,articulo,a la tesis,0.98,1
2025-05-10T15:11:14.654088,2025-05-10T15:11:14.654772,3,video,a la tesis,0.68,3
2025-05-10T15:11:14.640114,2025-05-10T15:11:14.641188,1,libro,a la tesis,1.07,2
2025-05-10T15:11:14.648137,2025-05-10T15:11:14.648834,2,tesis,a la tesis,0.7,1
2025-05-10T15:11:22.014041,2025-05-10T15:11:22.015605,3,video,a la tesis ecuaciones,1.58,3
2025-05-10T15:11:22.024002,2025-05-10T15:11:22.025297,4,articulo,a la tesis ecuaciones,1.3,1
2025-05-10T15:11:21.991769,2025-05-10T15:11:21.992996,1,libro,a la tesis ecuaciones,1.2,3
2025-05-10T15:11:22.003873,2025-05-10T15:11:22.005083,2,tesis,a la tesis ecuaciones,1.21,1
2025-05-10T15:11:28.814489,2025-05-10T15:11:28.815500,3,video,a la tesis ecuaciones programacion,1.02,3
2025-05-10T15:11:28.822734,2025-05-10T15:11:28.823583,4,articulo,a la tesis ecuaciones programacion,0.85,1
2025-05-10T15:11:28.789486,2025-05-10T15:11:28.791413,1,libro,a la tesis ecuaciones programacion,1.93,3
2025-05-10T15:11:28.805224,2025-05-10T15:11:28.806264,2,tesis,a la tesis ecuaciones programacion,1.04,1
2025-05-10T15:11:37.438989,2025-05-10T15:11:37.440049,3,video,a la tesis ecuaciones programación,1.06,3
2025-05-10T15:11:37.444958,2025-05-10T15:11:37.446324,4,articulo,a la tesis ecuaciones programación,1.37,1
2025-05-10T15:11:37.418471,2025-05-10T15:11:37.421244,1,libro,a la tesis ecuaciones programación,2.76,4
2025-05-10T15:11:37.430464,2025-05-10T15:11:37.432297,2,tesis,a la tesis ecuaciones programación,1.81,1
2025-05-10T18:15:21.499838,2025-05-10T18:15:21.501854,3,video,a de más programación,2.02,3
2025-05-10T18:15:21.463407,2025-05-10T18:15:21.473394,1,libro,a de más programación,10.02,2
2025-05-10T18:15:21.510838,2025-05-10T18:15:21.513072,4,articulo,a de más programación,2.23,1
2025-05-10T18:15:21.492509,2025-05-10T18:15:21.494307,2,tesis,a de más programación,1.8,2
2025-05-10T22:31:06.008509,2025-05-10T22:31:06.037436,2,tesis,ecuaciones diferenciales,28.23,0
2025-05-10T22:31:05.501593,2025-05-10T22:31:05.727859,1,libro,ecuaciones diferenciales,224.7,2
2025-05-10T22:31:06.231800,2025-05-10T22:31:06.261033,3,video,ecuaciones diferenciales,28.66,0
2025-05-10T22:31:06.543000,2025-05-10T22:31:06.615385,4,articulo,ecuaciones diferenciales,70.91,0
2025-05-10T22:32:54.191937,2025-05-10T22:32:54.205385,2,tesis,ecuaciones diferenciales,13.17,0
2025-05-10T22:32:54.044370,2025-05-10T22:32:54.072145,1,libro,ecuaciones diferenciales,27.32,2
2025-05-10T22:32:54.445875,2025-05-10T22:32:54.453891,4,articulo,ecuaciones diferenciales,7.57,0
2025-05-10T22:32:54.355290,2025-05-10T22:32:54.368655,3,video,ecuaciones diferenciales,13.04,0
2025-05-10T22:36:16.471338,2025-05-10T22:36:16.494119,3,video,{'video'},21.96,3
2025-05-10T22:36:16.002790,2025-05-10T22:36:16.094839,1,libro,{'libro'},89.92,3
2025-05-10T22:36:16.296114,2025-05-10T22:36:16.318188,2,tesis,{'tesis'},21.68,3
2025-05-10T23:07:22.213644,2025-05-10T23:07:22.310903,1,libro,{'libro'},95.09,3
2025-05-10T23:07:22.477334,2025-05-10T23:07:22.509006,2,tesis,{'tesis'},31.22,3
2025-05-10T23:07:22.677076,2025-05-10T23:07:22.706640,3,video,{'video'},28.57,3
2025-05-11T20:33:22.989177,2025-05-11T20:33:22.991671,3,video,posada errante,2.49,0
2025-05-11T20:33:22.978023,2025-05-11T20:33:22.979888,2,tesis,posada errante,1.86,0
2025-05-11T20:33:22.999469,2025-05-11T20:33:23.001043,4,articulo,posada errante,1.57,0
2025-05-11T20:33:22.936475,2025-05-11T20:33:22.941086,1,libro,posada errante,4.61,3
2025-05-11T20:39:17.211718,2025-05-11T20:39:17.215018,3,video,posada errante,3.31,0
2025-05-11T20:39:17.191245,2025-05-11T20:39:17.194108,2,tesis,posada errante,2.85,0
2025-05-11T20:39:17.170292,2025-05-11T20:39:17.174315,1,libro,posada errante,4.01,3
2025-05-11T20:39:17.228767,2025-05-11T20:39:17.231473,4,articulo,posada errante,2.62,0
2025-05-11T20:40:23.004248,2025-05-11T20:40:23.005072,4,articulo,posada errante,0.82,0
2025-05-11T20:40:22.998108,2025-05-11T20:40:22.998959,3,video,posada errante,0.85,0
2025-05-11T20:40:22.982220,2025-05-11T20:40:22.984587,1,libro,posada errante,2.37,3
2025-05-11T20:40:22.992245,2025-05-11T20:40:22.993186,2,tesis,posada errante,0.95,0
2025-05-11T20:40:39.232121,2025-05-11T20:40:39.233755,4,articulo,posada errante,1.64,0
2025-05-11T20:40:39.222059,2025-05-11T20:40:39.223463,3,video,posada errante,1.41,0
2025-05-11T20:40:39.201757,2025-05-11T20:40:39.204834,1,libro,posada errante,3.08,3,infante
2025-05-11T20:40:39.213447,2025-05-11T20:40:39.214946,2,tesis,posada errante,1.5,0
if match:
doc["ranking"] += 1
doc["rango_etario"] = match["nombre"]


# Score → suma de los rankings
total_score = sum(doc["ranking"] for doc in resultados)
resultados.sort(key=lambda x: x["ranking"], reverse=True)

else:
# Si no hay título, traer todos los del tipo
sql = f"SELECT *, 1 AS ranking FROM {tipo_documento_esclavo};"
cursor.execute(sql)
resultados = cursor.fetchall()
total_score = sum(doc["ranking"] for doc in resultados)

except mysql.connector.Error as err:
return jsonify({"error": f"Error en consulta a la base de datos: {err}"}), 500
except Exception as e:
return jsonify({"error": f"Error inesperado: {e}"}), 500


timestamp_fin = datetime.now().isoformat()
end_time = time.time()
tiempo_total_ms = round((end_time - start_time) * 1000, 2)  # tiempo en milisegundos

# Guardar en log
rango_etario = obtener_rango_etario(edad)
log_line = f"{timestamp_ini},{timestamp_fin},{id_maquina},{tipo_documento_esclavo},{titulo if titulo else {tipo_documento_esclavo}},{tiempo_total_ms},{total_score},{rango_etario}\n"
log_file = os.path.join(os.path.dirname(__file__), "log.txt")
with open(log_file, "a") as f:
f.write(log_line)

return jsonify({"resultados": resultados})

if __name__ == "__main__":
print(f"Esclavo corriendo en http://{host}:{puerto} tipo={tipo_documento_esclavo}")
app.run(host=host, port=puerto)
